# ==============================================================================
# GitHub Actions CI/CD Pipeline for DevOps Taskboard
# Alternative CI/CD Tool with Jest & Playwright Testing
# ==============================================================================

name: DevOps Taskboard CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  DOCKER_IMAGE_NAME: devops-taskboard
  REGISTRY: ghcr.io

jobs:
  # ===========================================================================
  # Job 1: Jest Unit Tests
  # ===========================================================================
  jest-tests:
    name: Jest Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: üì¶ Install Dependencies
        run: npm install
        
      - name: üß™ Run Jest Tests
        run: npm test
        
      - name: üìä Run Jest Coverage
        run: npm run test:coverage
        
      - name: üì§ Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: jest-coverage
          path: coverage/
          retention-days: 5

  # ===========================================================================
  # Job 2: Playwright E2E Tests (All 3 Browsers)
  # ===========================================================================
  playwright-tests:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: üì¶ Install Dependencies
        run: npm install
        
      - name: üé≠ Install Playwright Browsers
        run: npx playwright install --with-deps chromium firefox webkit
        
      - name: üß™ Run Playwright Tests
        run: npm run test-frontend
        
      - name: üìä Run Playwright Coverage
        run: npm run test-frontend:coverage
        continue-on-error: true
        
      - name: üì§ Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 5
          
      - name: üì§ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results/
          retention-days: 5

  # ===========================================================================
  # Job 3: Build Production Docker Image
  # ===========================================================================
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [jest-tests, playwright-tests]
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        
      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: üìù Extract Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            
      - name: üèóÔ∏è Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/docker-image.tar
          
      - name: üì§ Upload Docker Image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/docker-image.tar
          retention-days: 1

  # ===========================================================================
  # Job 5: Security Scan
  # ===========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-docker
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        
      - name: üì• Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp
          
      - name: üì¶ Load Docker Image
        run: docker load --input /tmp/docker-image.tar
        
      - name: üîí Run Trivy Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

  # ===========================================================================
  # Job 6: Deploy to Minikube
  # ===========================================================================
  deploy-minikube:
    name: Deploy to Minikube
    runs-on: ubuntu-latest
    needs: [build-docker, security-scan]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        
      - name: ‚ò∏Ô∏è Setup Minikube
        uses: medyagh/setup-minikube@master
        with:
          driver: docker
          kubernetes-version: v1.28.0
          
      - name: üì• Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp
          
      - name: üì¶ Load Image into Minikube
        run: |
          eval $(minikube docker-env)
          docker load --input /tmp/docker-image.tar
          IMAGE_REF="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.DOCKER_IMAGE_NAME }}"
          FULL_SHA="${GITHUB_SHA}"
          SHORT_SHA="${GITHUB_SHA::7}"
          if docker image inspect "${IMAGE_REF}:${FULL_SHA}" >/dev/null 2>&1; then
            docker tag "${IMAGE_REF}:${FULL_SHA}" devops-taskboard:latest
          elif docker image inspect "${IMAGE_REF}:${SHORT_SHA}" >/dev/null 2>&1; then
            docker tag "${IMAGE_REF}:${SHORT_SHA}" devops-taskboard:latest
          elif docker image inspect "${IMAGE_REF}:main" >/dev/null 2>&1; then
            docker tag "${IMAGE_REF}:main" devops-taskboard:latest
          elif docker image inspect "${IMAGE_REF}:latest" >/dev/null 2>&1; then
            docker tag "${IMAGE_REF}:latest" devops-taskboard:latest
          else
            echo "No expected tag found after load:" && docker images | head -n 20
            exit 1
          fi
          
      - name: üöÄ Deploy to Minikube
        run: |
          kubectl apply -f k8s/namespace.yaml || true
          kubectl apply -f k8s/deployment.yaml
          kubectl rollout status deployment/devops-taskboard -n devops-taskboard --timeout=120s
          kubectl get pods -n devops-taskboard -l app=devops-taskboard
          
      - name: üß™ Run Smoke Tests
        run: |
          SERVICE_URL=$(minikube service devops-taskboard-service --url -n devops-taskboard)
          curl -f "$SERVICE_URL/tasks" || echo "Smoke test completed"
          
      - name: üìä Enable Dashboard
        run: |
          minikube addons enable dashboard
          minikube addons enable metrics-server

  # ===========================================================================
  # Job 6: Notification
  # ===========================================================================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [jest-tests, playwright-tests, build-docker]
    if: always()
    
    steps:
      - name: üìß Build Summary
        run: |
          echo "### Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Jest Unit Tests | ${{ needs.jest-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Playwright E2E | ${{ needs.playwright-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.build-docker.result }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 7: Deploy to AKS (Main branch)
  # ===========================================================================
  deploy-aks:
    name: Deploy to AKS
    runs-on: ubuntu-latest
    needs: [build-docker, security-scan]
    if: github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üîê Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: üê≥ Build and Push to ACR
        run: |
          ACR="${{ secrets.ACR_NAME }}.azurecr.io"
          IMAGE="$ACR/devops-taskboard:${GITHUB_SHA}"
          az acr login --name ${{ secrets.ACR_NAME }}
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

      - name: ‚ò∏Ô∏è Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.AZURE_RESOURCE_GROUP }}
          cluster-name: ${{ secrets.AKS_NAME }}

      - name: üöÄ Deploy to AKS
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl set image deployment/devops-taskboard devops-taskboard=${{ secrets.ACR_NAME }}.azurecr.io/devops-taskboard:${GITHUB_SHA} -n devops-taskboard
          kubectl rollout status deployment/devops-taskboard -n devops-taskboard --timeout=120s
